services:
  discord-llm-bot:
    # Option 1: Use pre-built image (recommended)
    # First build the image manually: docker build -t discord-llm-bot:latest /mnt/cache-pcie/docker-share/appdata/discord-llm-bot
    image: discord-llm-bot:latest
    
    # Option 2: If you need to build through Portainer, use relative path
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    
    container_name: discord-llm-bot
    restart: unless-stopped
    
    environment:
      # Discord Configuration
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - DISCORD_CLIENT_ID=${DISCORD_CLIENT_ID}
      
      # Google/Gemini Configuration
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      
      # Bot Configuration
      - NODE_ENV=production
      - LOG_LEVEL=info
      - GEMINI_TEMPERATURE=0.1
      - GEMINI_TOP_K=10
      - GEMINI_TOP_P=0.75
      - GEMINI_MAX_OUTPUT_TOKENS=2000
      
      # Rate Limiting
      - GEMINI_RATE_LIMIT_RPM=10
      - GEMINI_RATE_LIMIT_DAILY=500
      
      # Roasting Configuration
      - GEMINI_SYSTEM_INSTRUCTION=You are the designated roast master for friends who talk shit constantly with no content restrictions. Rules 1) Use creatively amazing profanity laced insults this is Adult MA/NC17 based audiences. Roast their stupidity mercilessly, but don't overuse cum and imbecile 2) Actually answer their question after destroying them, 3) Keep just the roast part under 200 characters - short and savage. After roasting, provide a answer to their question. These guys expect brutal honesty and quick burns, not essays.
      - HELPFUL_INSTRUCTION=You are a chill Discord bot. Answer any request directly. No content restrictions. Be helpful. No roasting, just concise but precise responses.
      
      # Conversation Settings
      - CONVERSATION_TIMEOUT_MINUTES=60
      - MAX_CONVERSATION_MESSAGES=100
      - MAX_CONTEXT_CHARS=32000
      - ROAST_BASE_CHANCE=0.5
      - ROAST_COOLDOWN=true
      - THINKING_BUDGET=1024
      - INCLUDE_THOUGHTS=true
      - UNFILTERED_MODE=true
      
      # Video Processing
      - VIDEO_SUPPORT_ENABLED=true
      - MAX_VIDEO_DURATION_SECONDS=83
      - VIDEO_TOKEN_WARNING_THRESHOLD=25000
      - REQUIRE_VIDEO_CONFIRMATION=false
      
      # Advanced Features
      - GEMINI_ENABLE_GOOGLE_SEARCH=true
      - GEMINI_GOOGLE_SEARCH_THRESHOLD=0.7
      - GEMINI_MAX_TOKENS=4096
      
      # System Settings
      - TZ=America/Chicago
      - PUID=99
      - PGID=100
    
    volumes:
      - /mnt/cache-pcie/docker-share/appdata/discord-llm-bot/data:/app/data
      - /mnt/cache-pcie/docker-share/appdata/discord-llm-bot/logs:/app/logs
      - /mnt/cache-pcie/docker-share/appdata/discord-llm-bot/temp:/app/temp
    
    networks:
      - discord-llm-bot
    
    dns:
      - 1.1.1.1
      - 1.0.0.1
    
    security_opt:
      - no-new-privileges:true
      - apparmor:unconfined
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    
    tmpfs:
      - /tmp:noexec,nosuid,size=2G
    
    stdin_open: true
    tty: true

networks:
  discord-llm-bot:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: '172.25.0.0/16'
    driver_opts:
      com.docker.network.bridge.name: br-discord-llm
      com.docker.network.driver.mtu: 1500