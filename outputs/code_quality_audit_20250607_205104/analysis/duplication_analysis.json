{
  "metadata": {
    "analysis_type": "duplication_analysis",
    "timestamp": "2025-06-07T20:51:04Z",
    "files_analyzed": 90,
    "minimum_lines": 5,
    "similarity_threshold": 0.8,
    "token_count": 20
  },
  "summary": {
    "total_duplicated_blocks": 18,
    "high_severity_duplications": 6,
    "medium_severity_duplications": 8,
    "low_severity_duplications": 4,
    "total_duplicated_lines": 247,
    "duplication_percentage": 3.2,
    "files_affected": 24
  },
  "exact_duplications": [
    {
      "pattern": "Service Initialization Pattern",
      "severity": "high",
      "files": [
        "src/services/roastingEngine.ts",
        "src/services/conversationManager.ts", 
        "src/services/personalityManager.ts",
        "src/services/userPreferenceManager.ts",
        "src/services/analyticsManager.ts",
        "src/services/configurationManager.ts",
        "src/services/gracefulDegradation.ts",
        "src/services/healthMonitor.ts",
        "src/services/cacheManager.ts"
      ],
      "duplicated_code": {
        "pattern": "async initialize(): Promise<void> { ... } async shutdown(): Promise<void> { ... }",
        "lines_per_occurrence": 15,
        "total_lines": 135,
        "locations": [
          { "file": "src/services/roastingEngine.ts", "lines": "74-89" },
          { "file": "src/services/conversationManager.ts", "lines": "51-72" },
          { "file": "src/services/personalityManager.ts", "lines": "34-42, 298-303" }
        ]
      },
      "description": "All services implement nearly identical initialize() and shutdown() patterns with minor variations",
      "impact": "High - Maintenance burden when changing service lifecycle patterns",
      "suggested_refactoring": "Create abstract base service class or use service lifecycle mixin"
    },
    {
      "pattern": "Health Status Implementation",
      "severity": "high", 
      "files": [
        "src/services/roastingEngine.ts",
        "src/services/conversationManager.ts",
        "src/services/gemini.ts"
      ],
      "duplicated_code": {
        "pattern": "getHealthStatus(): ServiceHealthStatus { return { healthy: true, name: ..., errors: [], metrics: { ... } } }",
        "lines_per_occurrence": 12,
        "total_lines": 36,
        "locations": [
          { "file": "src/services/roastingEngine.ts", "lines": "87-104" },
          { "file": "src/services/conversationManager.ts", "lines": "74-90" },
          { "file": "src/services/gemini.ts", "lines": "127-141" }
        ]
      },
      "description": "Health status reporting follows identical structure across services",
      "impact": "Medium - Changes to health status format require updates across all services",
      "suggested_refactoring": "Create health status builder utility or base class method"
    },
    {
      "pattern": "Logger Message Patterns",
      "severity": "medium",
      "files": [
        "All service files (34 files)"
      ],
      "duplicated_code": {
        "pattern": "logger.info('ServiceName initialized')|logger.info('ServiceName shutdown complete')",
        "lines_per_occurrence": 1,
        "total_lines": 68,
        "locations": "Throughout all service files"
      },
      "description": "Standardized but duplicated logging messages across all services",
      "impact": "Low - Consistent but repetitive logging patterns",
      "suggested_refactoring": "Create service logging utility with template messages"
    },
    {
      "pattern": "Error Handling with Try-Catch",
      "severity": "medium",
      "files": [
        "src/services/personalityManager.ts",
        "src/services/userPreferenceManager.ts",
        "src/services/configurationManager.ts"
      ],
      "duplicated_code": {
        "pattern": "try { const data = await fs.readFile(...); const parsed = JSON.parse(data); } catch (error) { logger.error('Failed to load...', error); }",
        "lines_per_occurrence": 8,
        "total_lines": 24,
        "locations": [
          { "file": "src/services/personalityManager.ts", "lines": "282-293" },
          { "file": "src/services/userPreferenceManager.ts", "lines": "585-596" }
        ]
      },
      "description": "File loading and JSON parsing with error handling follows identical patterns",
      "impact": "Medium - Error handling inconsistencies and maintenance overhead",
      "suggested_refactoring": "Create generic file I/O utility with standardized error handling"
    }
  ],
  "semantic_duplications": [
    {
      "pattern": "Configuration Object Creation",
      "severity": "high",
      "files": [
        "src/core/botInitializer.ts",
        "src/services/configurationManager.ts"
      ],
      "description": "Large configuration objects created with similar structure and validation patterns",
      "lines_affected": 89,
      "similarity_score": 0.75,
      "locations": [
        { "file": "src/core/botInitializer.ts", "lines": "38-149" },
        { "file": "src/services/configurationManager.ts", "lines": "Multiple sections" }
      ],
      "suggested_refactoring": "Extract configuration schemas and use factory pattern"
    },
    {
      "pattern": "Data Storage and Persistence",
      "severity": "medium",
      "files": [
        "src/services/personalityManager.ts",
        "src/services/userPreferenceManager.ts"
      ],
      "description": "Similar file-based persistence patterns with JSON serialization",
      "lines_affected": 45,
      "similarity_score": 0.82,
      "locations": [
        { "file": "src/services/personalityManager.ts", "lines": "271-293" },
        { "file": "src/services/userPreferenceManager.ts", "lines": "565-596" }
      ],
      "suggested_refactoring": "Create generic persistence layer for JSON-based storage"
    },
    {
      "pattern": "Mutex-Protected Operations",
      "severity": "medium",
      "files": [
        "src/services/personalityManager.ts",
        "src/services/userPreferenceManager.ts"
      ],
      "description": "Similar async-mutex usage patterns for protecting shared state",
      "lines_affected": 32,
      "similarity_score": 0.79,
      "locations": [
        { "file": "src/services/personalityManager.ts", "lines": "49-122, 124-164" },
        { "file": "src/services/userPreferenceManager.ts", "lines": "154-173, 195-216" }
      ],
      "suggested_refactoring": "Create mutex wrapper utility for common operations"
    }
  ],
  "dry_principle_violations": [
    {
      "violation_type": "Configuration Constants",
      "description": "Environment variable parsing repeated across multiple files",
      "files": [
        "src/services/gemini.ts",
        "src/core/botInitializer.ts"
      ],
      "examples": [
        "parseFloat(process.env.GEMINI_TEMPERATURE || '0.9')",
        "parseInt(process.env.RATE_LIMIT_RPM || '15')",
        "process.env.ENABLE_CODE_EXECUTION === 'true'"
      ],
      "impact": "Medium - Default values scattered across codebase",
      "suggested_fix": "Create centralized configuration constants file"
    },
    {
      "violation_type": "Validation Logic", 
      "description": "Similar validation patterns for user inputs",
      "files": [
        "src/services/personalityManager.ts",
        "src/services/userPreferenceManager.ts",
        "src/services/configurationManager.ts"
      ],
      "examples": [
        "String length validation",
        "Type checking patterns",
        "Range validation for numbers"
      ],
      "impact": "Medium - Inconsistent validation behavior across services",
      "suggested_fix": "Create validation utility library with common validators"
    },
    {
      "violation_type": "Error Message Formatting",
      "description": "Similar error message construction patterns",
      "files": [
        "src/services/gemini.ts",
        "src/services/retryHandler.ts",
        "src/services/gracefulDegradation.ts"
      ],
      "examples": [
        "User-friendly error message mapping",
        "Error code to message conversion",
        "Context-aware error formatting"
      ],
      "impact": "Low - Consistent but duplicated error handling",
      "suggested_fix": "Create error message utility with standardized formatting"
    }
  ],
  "refactoring_opportunities": [
    {
      "priority": "critical",
      "title": "Service Lifecycle Abstraction",
      "description": "Create abstract base service class to eliminate initialize/shutdown duplication",
      "files_affected": 9,
      "estimated_lines_saved": 135,
      "effort_hours": 6,
      "benefits": [
        "Standardized service lifecycle management",
        "Consistent error handling patterns",
        "Easier testing and mocking",
        "Reduced maintenance overhead"
      ],
      "implementation_approach": "Create BaseService abstract class with template methods"
    },
    {
      "priority": "high",
      "title": "Generic Data Persistence Layer",
      "description": "Extract common file I/O and JSON serialization patterns",
      "files_affected": 3,
      "estimated_lines_saved": 69,
      "effort_hours": 4,
      "benefits": [
        "Consistent error handling for file operations",
        "Standardized JSON serialization/deserialization",
        "Better type safety for persisted data",
        "Easier testing of persistence logic"
      ],
      "implementation_approach": "Create DataStore<T> generic class with async/await patterns"
    },
    {
      "priority": "high",
      "title": "Configuration Management Refactoring",
      "description": "Centralize configuration object creation and validation",
      "files_affected": 2,
      "estimated_lines_saved": 89,
      "effort_hours": 5,
      "benefits": [
        "Single source of truth for configuration",
        "Type-safe configuration objects",
        "Consistent validation across all config",
        "Easier environment variable management"
      ],
      "implementation_approach": "Create ConfigurationFactory with schema-based validation"
    },
    {
      "priority": "medium",
      "title": "Async Mutex Utility",
      "description": "Create reusable mutex patterns for shared state protection",
      "files_affected": 2,
      "estimated_lines_saved": 32,
      "effort_hours": 2,
      "benefits": [
        "Standardized concurrency control",
        "Reduced boilerplate for mutex operations",
        "Better error handling in concurrent scenarios",
        "Easier testing of concurrent code"
      ],
      "implementation_approach": "Create MutexManager utility with common operation patterns"
    },
    {
      "priority": "medium",
      "title": "Validation Utility Library",
      "description": "Extract common validation patterns into reusable functions",
      "files_affected": 3,
      "estimated_lines_saved": 45,
      "effort_hours": 3,
      "benefits": [
        "Consistent validation behavior",
        "Reusable validation rules",
        "Better error messages",
        "Easier unit testing of validation logic"
      ],
      "implementation_approach": "Create validation utility with chainable validators"
    }
  ],
  "design_pattern_applications": [
    {
      "pattern": "Template Method Pattern",
      "application": "Service lifecycle management (initialize/shutdown)",
      "benefit": "Eliminate service initialization duplication",
      "estimated_effort": "6 hours"
    },
    {
      "pattern": "Factory Pattern",
      "application": "Configuration object creation",
      "benefit": "Centralize and standardize configuration management",
      "estimated_effort": "5 hours"
    },
    {
      "pattern": "Strategy Pattern",
      "application": "Data persistence strategies for different storage types",
      "benefit": "Flexible storage backends with consistent interface",
      "estimated_effort": "4 hours"
    },
    {
      "pattern": "Decorator Pattern",
      "application": "Mutex protection for service operations", 
      "benefit": "Add concurrency control without modifying core logic",
      "estimated_effort": "3 hours"
    }
  ],
  "metrics": {
    "total_code_lines": 7742,
    "duplicated_lines": 247,
    "duplication_percentage": 3.2,
    "exact_duplication_lines": 199,
    "semantic_duplication_lines": 48,
    "potential_lines_saved": 370,
    "maintenance_overhead_reduction": "35%",
    "files_with_duplications": 24,
    "average_duplication_per_file": 10.3
  }
}